<html>
<head>
  <meta charset="utf-8">
  <title>Go Forward Switch</title>
  <meta name="author" content="Ye Chen">
  <meta name="description" content="Test collider in A-Frame">
  <script src="../aframe-v0.2.0-OBJ.js"></script>
  <script src="../aframe-extras.min.js"></script>
  <script src="../aframe-fence-component.min.js"></script>
  <script src="../aframe-htmltexture-component.min.js"></script>
  <script src="../aframe-draw-component.min.js"></script>
  <!-- <script src="../aframe-randomizer-components.min.js"></script> -->
  <!-- <script src="../aframe-animation-component.min.js"></script> -->
  <style type="text/css">
<!--   #score {
        color: dark;
        position: fixed;
        top: 10px;
        left: 10px;
        font-family: monospace;
        font-size: 20px;
        z-index: 99999;
      } -->
  #score{
	font-size: 48px;
	line-height: 64px;
	background: #f70;
	border: 1px solid #a30;
	z-index: -1;
  }
  </style>
</head>

<body>
  <a-scene physics="debug: false">
	<!-- 预先加载的资源 -->
    <a-asset>
		<img src="../assets/sky5.jpg" alt="" id="sky5"/>
		<img src="../assets/one_Number_256px.png" alt="" id="one_Number"/>
		<img src="../assets/Two_Number_256px.png" alt="" id="Two_Number"/>
		
		<img src="./img/panda2.jpg" alt="" id="enemyAwesome"/>
		<img src="./img/panda.jpg" alt="" id="enemyOrdinary"/>
		
		<img src="./img/floor.jpg" alt="" id="floor"/>
		
		<a-mixin id="enemyPosition" attribute="position" to="0 0 -1000" dur="500" begin="disappear"></a-mixin>
		<a-mixin id="enemyScale" attribute="scale" to="0 0 0" dur="500" begin="collided"></a-mixin>
		<a-mixin id="enemyMixin" static-body="" depth="2" width="4" height="6" src="./img/Obama.jpg"></a-mixin>
				
		<div id="score">
			<center>0</center>
		</div>
	</a-asset>
	
	
	<!-- 用户 -->
	<!-- <a-entity id="player" position="0 1.8 0"> -->
	<a-camera id="camera" kinematic-body="shape: auto" universal-controls positon="0 1.8 0" rotation="0 -180 0" fence="width: 100; depth: 100; x0: 0; z0: 0">
		<a-cursor id="cursor" color="#0f0" fuse="true"></a-cursor>
		<!-- 显示分数 -->
		<a-entity id="scoreDisplay" geometry="primitive: plane" position="-0.3 0.4 -1" draw="width: 128; height: 64;" 
			htmltexture="asset: #score" scale="0.2 0.2 0.2" ></a-entity>
		<a-entity id="youDie" visible="false" static-body geometry="primitive: plane; height: 2; width: 4" scale="0.2 0.2 0.2" rotation="0 0 0" position="0 0 -1" material="shader: standard; src: url(./img/youDie.png); side: double; repeat: 1 1"></a-entity>
	</a-camera>
	
	<!-- </a-entity> -->
	
	<!-- <a-image width="1" height="0.5" src="../assets/sky2-small.jpg" position="0 -2.5 0" rotation="90 0 0"></a-image> -->
	<!-- 前进开关 -->
	<a-ring id="goSwitch" radius-inner="0" radius-outer="0.25" position="0 -2.9 0" src="#one_Number" rotation="-90 0 0" scale="1.5 1.5 1"></a-ring>
	
	
	<!-- 全景图背景 -->
    <a-sky color="#fff" src="#sky5"></a-sky>
	
	
	<a-entity static-body geometry="primitive: plane; height: 100; width: 100" rotation="90 0 0" position="0 -3 0" 
		 material="shader: standard; src: #floor; side: double; repeat: 6 6"></a-entity>
	<!-- <a-plane static-body color="#000" height="500" width="500" rotation="90 0 0" position="0 -3 0" transparent="true" opacity="0.5"></a-plane> -->
	
<!-- 	<a-entity geometry="primitive: box"
              random-position="min:0 0 0; max:5 0 5" random-rotation random-scale></a-entity> -->
	
	<a-box id="testBox" class="enemy" static-body depth="2" width="4" height="6" position="0 0 -5" src="#enemyOrdinary">
		<a-animation class="randomMove" attribute="position" to="0 0 -5" dur="1000" begin="0" repeat="indefinite"></a-animation>
		<a-animation mixin="enemyPosition"></a-animation>
		<a-animation mixin="enemyScale"></a-animation></a-box>
  	<a-box class="enemy" static-body depth="2" width="4" height="6" position="0 0 5" src="#enemyOrdinary">
		<a-animation class="randomMove" attribute="position" to="0 0 5" dur="1000" begin="0" repeat="indefinite"></a-animation>
		<a-animation mixin="enemyPosition"></a-animation>
		<a-animation mixin="enemyScale"></a-animation></a-box>
	<a-box class="enemy" static-body depth="2" width="4" height="6" position="-10 0 -10" src="#enemyOrdinary">
		<a-animation class="randomMove" attribute="position" to="-10 0 -10" dur="1000" begin="0" repeat="indefinite"></a-animation>
		<a-animation mixin="enemyPosition"></a-animation>
		<a-animation mixin="enemyScale"></a-animation></a-box>
	<a-box class="enemy" static-body depth="2" width="4" height="6" position="0 0 -10" src="#enemyOrdinary">
		<a-animation class="randomMove" attribute="position" to="0 0 -10" dur="1000" begin="0" repeat="indefinite"></a-animation>
		<a-animation mixin="enemyPosition"></a-animation>
		<a-animation mixin="enemyScale"></a-animation></a-box>
	<a-box class="enemy" static-body depth="2" width="4" height="6" position="20 0 5" src="#enemyOrdinary">
		<a-animation class="randomMove" attribute="position" to="20 0 5" dur="1000" begin="0" repeat="indefinite"></a-animation>
		<a-animation mixin="enemyPosition"></a-animation>
		<a-animation mixin="enemyScale"></a-animation></a-box>
	<a-box class="enemy" static-body depth="2" width="4" height="6" position="50 0 20" src="#enemyOrdinary">
		<a-animation class="randomMove" attribute="position" to="50 0 20" dur="1000" begin="0" repeat="indefinite"></a-animation>
		<a-animation mixin="enemyPosition"></a-animation>
		<a-animation mixin="enemyScale"></a-animation></a-box>	
	<a-box class="enemy" static-body depth="2" width="4" height="6" position="-40 0 40" src="#enemyOrdinary">
		<a-animation class="randomMove" attribute="position" to="-40 0 40" dur="1000" begin="0" repeat="indefinite"></a-animation>
		<a-animation mixin="enemyPosition"></a-animation>
		<a-animation mixin="enemyScale"></a-animation></a-box>	
	<a-box class="enemy" static-body depth="2" width="4" height="6" position="40 0 -30" src="#enemyOrdinary">
		<a-animation class="randomMove" attribute="position" to="40 0 -30" dur="1000" begin="0" repeat="indefinite"></a-animation>
		<a-animation mixin="enemyPosition"></a-animation>
		<a-animation mixin="enemyScale"></a-animation></a-box>	
	<a-box class="enemy" static-body depth="2" width="4" height="6" position="30 0 40" src="#enemyOrdinary">
		<a-animation class="randomMove" attribute="position" to="30 0 40" dur="1000" begin="0" repeat="indefinite"></a-animation>
		<a-animation mixin="enemyPosition"></a-animation>
		<a-animation mixin="enemyScale"></a-animation></a-box>	
	<a-box class="enemy" static-body depth="2" width="4" height="6" position="-40 0 -30" src="#enemyOrdinary">
		<a-animation class="randomMove" attribute="position" to="-40 0 -30" dur="1000" begin="0" repeat="indefinite"></a-animation>
		<a-animation mixin="enemyPosition"></a-animation>
		<a-animation mixin="enemyScale"></a-animation></a-box>
	
	<!-- <a-entity text="text: What's up" position="0 0 0"></a-entity> -->
	
	<a-sphere class="bigBean" static-body radius="0.5" position="0 -2 -3" >
		<a-animation mixin="enemyPosition"></a-animation>
		<a-animation mixin="enemyScale"></a-animation></a-sphere>
	

	
  </a-scene>
  <script type="text/javascript">
	var camera = document.querySelector("#camera");
	console.log("Get entity:"+camera.id);
	//camera.addState("ordinary");
	var cameraState = "ordinary";
	var enemies = document.querySelectorAll('[class=enemy]');
	var randomMoves = document.querySelectorAll('[class=randomMove]');
	var goSwitch = document.querySelector("#goSwitch");
	var scoreDisplay = document.querySelector("#scoreDisplay");
	var velocity0 = 0.004;
	var velocity = 0.004;
	var velocity3 = {x:0, y:0, z:-0.004};
	var deltaT = 10;
	var ifForward = false;
	function goForward(){
		//console.log("Go forward!");
		var rotationCamera = camera.getAttribute("rotation");
		if(rotationCamera.x < -45) velocity = velocity0*(rotationCamera.x/45+2);
		else velocity = velocity0;
		velocity3.x = -velocity*Math.sin(rotationCamera.y/180*Math.PI);
		velocity3.y = 0;
		velocity3.z = -velocity*Math.cos(rotationCamera.y/180*Math.PI);
		var positionCamera = camera.getAttribute("position");
		var positionGoSwitch = goSwitch.getAttribute("position");
		var deltaP = {x:0, y:0, z:-2};
		deltaP.x = deltaT*velocity3.x;
		deltaP.y = deltaT*velocity3.y;
		deltaP.z = deltaT*velocity3.z;
		positionCamera.x = positionCamera.x + deltaP.x;
		positionCamera.y = positionCamera.y + deltaP.y;
		positionCamera.z = positionCamera.z + deltaP.z;
		//camera.setAttribute("velocity", {x:0, y:0, z:-5});
		camera.setAttribute("position", positionCamera);
		positionGoSwitch.x = positionCamera.x;
		//positionGoSwitch.y = positionCamera.y-2.9;
		positionGoSwitch.z = positionCamera.z;
		goSwitch.setAttribute("position", positionGoSwitch);
        //console.log(positionCamera);
		
	}
	//var t1 = window.setInterval(goForward,deltaT);
	//goForward();
	var goTimer;
	goSwitch.addEventListener("click",function (){
		if(ifForward == false){
			goTimer = window.setInterval(goForward,deltaT);
			ifForward = true;
			goSwitch.setAttribute("src","#two_Number");
			console.log("Go forward!");
		}
		else {
			window.clearInterval(goTimer); 
			ifForward = false;
			goSwitch.setAttribute("src","#one_Number");
			console.log("Stop going forward!");
		}	
	});
		
	function backToOrdinary(){
		cameraState = "ordinary"; 
		console.log("Camera state: " + cameraState);
		for(var i=0;i<enemies.length;i++){
			enemies[i].setAttribute("src", "#enemyOrdinary");
		}
	}
		
	var scoreEl = document.querySelector('#score center');
	var score = 0;
	var stopTimer;
	camera.addEventListener('collide', function (e) {
		//window.clearInterval(goTimer); 
		body = e.detail.body.el;
		//console.log(body.getAttribute('class'));
		if( body.getAttribute('class')=='enemy' ){
			if(cameraState == "awesome"){
				score+=1;
				//scoreEl.innerHTML = 'Score: ' + score;
				scoreEl.innerHTML = score;
				body.emit('collided');
				setTimeout("body.emit('disappear'); body.pause();",500);			
			}
			else if(cameraState == "ordinary"){
				document.querySelector("#youDie").setAttribute("visible", true);
				//camera.pause();
				console.log("You die!");
				window.clearInterval(goTimer); 
				ifForward = false;
				goSwitch.setAttribute("src","#one_Number");
				console.log("Stop going forward!");
				
				cameraState == "dead";
				console.log("Camera state: " + cameraState);
			}

			//delete body;
			//document.removeElement(body);
			//setTimeout("delete body;",500);
			//body.removeAttribute('static-body');
		}
		if( body.getAttribute('class')=='bigBean' ){
			cameraState = "awesome";
			console.log("Camera state: " + cameraState);
			setTimeout('backToOrdinary();',10000);
			for(var i=0;i<enemies.length;i++){
				enemies[i].setAttribute("src", "#enemyAwesome");
			}
		}
		
		//e.detail.body.el.setAttribute("visible", false);
		//var body = document.querySelector("#"+e.detail.body.id);
		//body.setAttribute("visible", false);
		//goTimer = window.setInterval(goForward,deltaT);
		console.log('Player has collided with body #' + e.detail.body.id);

		//console.log(e.detail.target.el.id);  // Original entity (playerEl).
		//console.log(e.detail.body);    // Other entity, which playerEl touched.
		//console.log(e.detail.contact);    // Stats about the collision (CANNON.ContactEquation).
		//console.log(e.detail.contact.ni); // Normal (direction) of the collision (CANNON.Vec3).
	});
	
	//var randomMove = document.querySelector("#randomMove");
	function setRandomMove1(El){
		r1 = Math.round(Math.random());
		r2 = Math.round(Math.random());
		var toOld = El.getAttribute("to");
		El.setAttribute("from",toOld);
		var to = toOld.split(' ');
		if(r1 == 0){
			if(r2 == 0){
				to[0] = (parseInt(to[0]) - 2).toString();
			}
			else{
				to[0] = (parseInt(to[0]) + 2).toString();
			}
		}
		else{
			if(r2 == 0){			
				to[2] = (parseInt(to[2]) - 2).toString();
			}
			else{
				to[2] = (parseInt(to[2]) + 2).toString();
			}
		}
		El.setAttribute("to",to.join(' '));
	}
	function setRandomMove(El){
		r1 = Math.round(Math.random());
		r2 = Math.round(Math.random());
		var boxPosition = El.getAttribute("position");
		if(r1 == 0){
			if(r2 == 0){
				boxPosition.x = boxPosition.x - 2;
			}
			else{
				boxPosition.x = boxPosition.x + 2;
			}
		}
		else{
			if(r2 == 0){			
				boxPosition.z = boxPosition.z - 2;
			}
			else{
				boxPosition.z = boxPosition.z + 2;
			}
		}
		El.setAttribute("position",boxPosition);
	}
	function moveAll(){
		//enemies.forEach(function(enemyEl) {
		//	setRandomMove(enemyEl);
		//});
//		randomMoves.forEach(function(El) {
//			setRandomMove1(El);
//		});
		for(var i=0;i<randomMoves.length;i++)
		{
			setRandomMove1(randomMoves[i]);
		}
	}
	var moveTimer = window.setInterval(moveAll,1000);
	
	
	
  </script>
</body>
</html>

